<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Telemetry Dashboard - British Made AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f3;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: #666;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: #C67E5F;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .health-status {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .health-indicator.healthy {
            background: #dcfce7;
            color: #16a34a;
        }

        .health-indicator.unhealthy {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #22c55e;
        }

        .status-dot.red {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .funnel-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }

        .funnel-stage {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: #f0f0f0;
            margin: 0 5px;
            border-radius: 8px;
            position: relative;
        }

        .funnel-stage.active {
            background: linear-gradient(135deg, #C67E5F, #8B9A7B);
            color: white;
        }

        .funnel-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .funnel-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .funnel-percentage {
            font-size: 14px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .popularity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .popularity-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 8px 0;
        }

        .popularity-bar {
            flex: 1;
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            margin: 0 12px;
            overflow: hidden;
        }

        .popularity-fill {
            height: 100%;
            background: linear-gradient(90deg, #C67E5F, #D4A574);
        }

        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin: 20px 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: #e5e5e5;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .heatmap-cell.low { background: #fef3c7; color: #92400e; }
        .heatmap-cell.medium { background: #fbbf24; color: #78350f; }
        .heatmap-cell.high { background: #f59e0b; color: white; }
        .heatmap-cell.very-high { background: #d97706; color: white; }

        .journey-path {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 8px 0;
            overflow-x: auto;
        }

        .journey-step {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            margin: 0 4px;
            font-size: 14px;
            white-space: nowrap;
        }

        .journey-arrow {
            color: #999;
            margin: 0 4px;
        }

        .dead-end-item {
            padding: 12px;
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
            margin: 8px 0;
        }

        .abandonment-item {
            padding: 12px;
            background: #fff7ed;
            border-left: 3px solid #f97316;
            border-radius: 4px;
            margin: 8px 0;
        }

        .success-metric {
            background: #dcfce7;
            padding: 16px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .price-range-bar {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .price-range-label {
            width: 120px;
            font-size: 14px;
        }

        .price-range-count {
            margin-left: auto;
            font-weight: 600;
        }

        .refresh-btn {
            background: #C67E5F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }

        .export-btn {
            background: #8B9A7B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .insight-box {
            background: linear-gradient(135deg, #fef3c7, #fef9c3);
            border: 2px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .insight-box h4 {
            color: #92400e;
            margin-bottom: 8px;
        }

        .insight-box ul {
            list-style-position: inside;
            color: #78350f;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üöÄ Comprehensive Telemetry Dashboard</h1>
        <p>Deep insights into user behavior, system health, and business metrics</p>

        <div class="health-status">
            <div class="health-indicator" id="priceStatus">
                <span class="status-dot"></span>
                <span>Price API</span>
            </div>
            <div class="health-indicator" id="chatStatus">
                <span class="status-dot"></span>
                <span>Chat API</span>
            </div>
            <div class="health-indicator" id="overallHealth">
                <span class="status-dot"></span>
                <span>Overall Health</span>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="export-btn" onclick="exportData()">üì• Export</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('funnel')">Conversion Funnel</button>
            <button class="nav-tab" onclick="switchTab('products')">Product Insights</button>
            <button class="nav-tab" onclick="switchTab('pricing')">Price Sensitivity</button>
            <button class="nav-tab" onclick="switchTab('journeys')">User Journeys</button>
            <button class="nav-tab" onclick="switchTab('performance')">Performance</button>
            <button class="nav-tab" onclick="switchTab('issues')">Issues & Dead Ends</button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Conversion Rate</h3>
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-label">Query to completion</div>
            </div>
            <div class="stat-card">
                <h3>Avg Time to Success</h3>
                <div class="stat-value" id="avgTimeToSuccess">0s</div>
                <div class="stat-label">Finding right price</div>
            </div>
            <div class="stat-card">
                <h3>Cross-sell Rate</h3>
                <div class="stat-value" id="crossSellRate">0%</div>
                <div class="stat-label">Opportunities clicked</div>
            </div>
            <div class="stat-card">
                <h3>Abandonment Rate</h3>
                <div class="stat-value" id="abandonmentRate">0%</div>
                <div class="stat-label">Sessions incomplete</div>
            </div>
            <div class="stat-card">
                <h3>Query Success Rate</h3>
                <div class="stat-value" id="querySuccess">0%</div>
                <div class="stat-label">Queries with results</div>
            </div>
            <div class="stat-card">
                <h3>NLU Confidence</h3>
                <div class="stat-value" id="nluConfidence">0%</div>
                <div class="stat-label">Understanding score</div>
            </div>
        </div>

        <div class="insight-box">
            <h4>üí° Key Insights</h4>
            <ul id="keyInsights">
                <li>Loading insights...</li>
            </ul>
        </div>
    </div>

    <!-- Conversion Funnel Tab -->
    <div id="funnel" class="tab-content">
        <div class="chart-container">
            <div class="chart-title">üìä Conversion Funnel</div>
            <div class="funnel-container" id="funnelContainer">
                <!-- Funnel stages will be populated here -->
            </div>
            <canvas id="funnelChart" height="100"></canvas>
        </div>
    </div>

    <!-- Product Insights Tab -->
    <div id="products" class="tab-content">
        <div class="popularity-grid">
            <div class="chart-container">
                <div class="chart-title">üõãÔ∏è Product Popularity</div>
                <div id="productPopularity">
                    <!-- Product popularity will be populated here -->
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üé® Fabric Popularity</div>
                <div id="fabricPopularity">
                    <!-- Fabric popularity will be populated here -->
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">‚è∞ Peak Usage Heatmap (24hr)</div>
            <div class="heatmap-container" id="usageHeatmap">
                <!-- Heatmap will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">
                Hours of the day (0-23)
            </div>
        </div>
    </div>

    <!-- Price Sensitivity Tab -->
    <div id="pricing" class="tab-content">
        <div class="chart-container">
            <div class="chart-title">üí∞ Price Range Distribution</div>
            <div id="priceRanges">
                <!-- Price ranges will be populated here -->
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-title">üìâ Budget Queries</div>
            <div id="budgetQueries">
                <!-- Budget queries will be populated here -->
            </div>
        </div>
    </div>

    <!-- User Journeys Tab -->
    <div id="journeys" class="tab-content">
        <div class="chart-container">
            <div class="chart-title">üó∫Ô∏è Common Journey Paths</div>
            <div id="journeyPaths">
                <!-- Journey paths will be populated here -->
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-title">‚è±Ô∏è Time to Success Metrics</div>
            <div id="successMetrics">
                <!-- Success metrics will be populated here -->
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-title">üö™ Abandonment Analysis</div>
            <div id="abandonmentAnalysis">
                <!-- Abandonment analysis will be populated here -->
            </div>
        </div>
    </div>

    <!-- Performance Tab -->
    <div id="performance" class="tab-content">
        <div class="chart-container">
            <div class="chart-title">‚ö° Response Time Trends</div>
            <canvas id="performanceChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">üîÑ Query Reformulation Rate</div>
            <div id="reformulationRate">
                <!-- Reformulation data will be populated here -->
            </div>
        </div>
    </div>

    <!-- Issues & Dead Ends Tab -->
    <div id="issues" class="tab-content">
        <div class="chart-container">
            <div class="chart-title">üö´ Dead-End Queries</div>
            <div id="deadEnds">
                <!-- Dead ends will be populated here -->
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-title">‚ùå Recent Errors</div>
            <div id="recentErrors">
                <!-- Errors will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const AUTH_KEY = 'britishmade_authenticated';
        const isAuthenticated = sessionStorage.getItem(AUTH_KEY);

        if (!isAuthenticated || isAuthenticated !== 'true') {
            window.location.href = '/';
        }

        let allEvents = [];
        let aggregatedMetrics = {};
        let currentTab = 'overview';
        let charts = {};

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            currentTab = tabName;

            renderTabContent(tabName);
        }

        function loadData() {
            const stored = localStorage.getItem('analyticsEvents');
            const aggregated = localStorage.getItem('analyticsAggregated');

            allEvents = stored ? JSON.parse(stored) : [];
            aggregatedMetrics = aggregated ? JSON.parse(aggregated) : {};

            renderDashboard();
        }

        function refreshData() {
            loadData();
            showNotification('Data refreshed');
        }

        function exportData() {
            const exportData = {
                events: allEvents,
                metrics: aggregatedMetrics,
                timestamp: new Date().toISOString()
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telemetry-comprehensive-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderDashboard() {
            renderHealthStatus();
            renderOverview();
            renderTabContent(currentTab);
        }

        function renderHealthStatus() {
            // Similar to enhanced dashboard
            const healthChecks = allEvents.filter(e => e.eventName === 'health_check');
            if (healthChecks.length > 0) {
                const latest = healthChecks[healthChecks.length - 1];
                // Update indicators...
            }
        }

        function renderOverview() {
            // Calculate key metrics
            const queries = allEvents.filter(e => e.eventName === 'user_query');
            const completions = aggregatedMetrics.userJourneys?.completions || [];
            const abandonments = aggregatedMetrics.userJourneys?.abandonments || [];
            const timeToSuccess = aggregatedMetrics.userJourneys?.timeToSuccess || [];

            // Conversion rate
            const conversionRate = queries.length > 0
                ? ((completions.length / queries.length) * 100).toFixed(1)
                : 0;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;

            // Average time to success
            const avgTime = timeToSuccess.length > 0
                ? timeToSuccess.reduce((a, b) => a + b.time, 0) / timeToSuccess.length / 1000
                : 0;
            document.getElementById('avgTimeToSuccess').textContent = `${Math.round(avgTime)}s`;

            // Cross-sell rate
            const crossSellRate = aggregatedMetrics.crossSell?.attachmentRate || 0;
            document.getElementById('crossSellRate').textContent = `${crossSellRate.toFixed(1)}%`;

            // Abandonment rate
            const totalSessions = new Set(allEvents.map(e => e.sessionId)).size;
            const abandonRate = totalSessions > 0
                ? ((abandonments.length / totalSessions) * 100).toFixed(1)
                : 0;
            document.getElementById('abandonmentRate').textContent = `${abandonRate}%`;

            // Query success rate
            const deadEnds = aggregatedMetrics.queryPatterns?.deadEnds || [];
            const successRate = queries.length > 0
                ? (((queries.length - deadEnds.length) / queries.length) * 100).toFixed(1)
                : 0;
            document.getElementById('querySuccess').textContent = `${successRate}%`;

            // NLU confidence
            const nluConfidence = aggregatedMetrics.nluScoring?.avgConfidence || 0;
            document.getElementById('nluConfidence').textContent = `${Math.round(nluConfidence)}%`;

            // Generate insights
            renderInsights();
        }

        function renderInsights() {
            const insights = [];

            // Product insights
            const products = aggregatedMetrics.productPopularity || [];
            if (products.length > 0) {
                const topProduct = products.sort((a, b) => b[1] - a[1])[0];
                insights.push(`Most searched product: ${topProduct[0]} (${topProduct[1]} searches)`);
            }

            // Price sensitivity
            const budgetQueries = aggregatedMetrics.priceSensitivity?.budgetQueries || [];
            if (budgetQueries.length > 0) {
                const avgBudget = budgetQueries.reduce((a, b) => a + b.budget, 0) / budgetQueries.length;
                insights.push(`Average budget: ¬£${Math.round(avgBudget)}`);
            }

            // Peak usage
            const peakHours = aggregatedMetrics.peakUsage?.hourly || [];
            if (peakHours.length > 0) {
                const maxHour = peakHours.indexOf(Math.max(...peakHours));
                insights.push(`Peak usage hour: ${maxHour}:00`);
            }

            // Dead ends
            const deadEnds = aggregatedMetrics.queryPatterns?.deadEnds || [];
            if (deadEnds.length > 0) {
                insights.push(`${deadEnds.length} queries resulted in no results`);
            }

            const insightsList = document.getElementById('keyInsights');
            insightsList.innerHTML = insights.length > 0
                ? insights.map(i => `<li>${i}</li>`).join('')
                : '<li>No insights available yet</li>';
        }

        function renderTabContent(tabName) {
            switch(tabName) {
                case 'funnel':
                    renderFunnel();
                    break;
                case 'products':
                    renderProductInsights();
                    break;
                case 'pricing':
                    renderPriceSensitivity();
                    break;
                case 'journeys':
                    renderJourneys();
                    break;
                case 'performance':
                    renderPerformance();
                    break;
                case 'issues':
                    renderIssues();
                    break;
            }
        }

        function renderFunnel() {
            const sessions = aggregatedMetrics.conversionFunnel?.sessions || [];
            const stages = ['query_started', 'price_shown', 'opportunity_clicked', 'configuration_complete'];

            const stageCounts = stages.map(stage =>
                sessions.filter(s => s[1].stages.includes(stage)).length
            );

            const container = document.getElementById('funnelContainer');
            container.innerHTML = stages.map((stage, i) => {
                const count = stageCounts[i];
                const percentage = stageCounts[0] > 0
                    ? ((count / stageCounts[0]) * 100).toFixed(1)
                    : 0;

                return `
                    <div class="funnel-stage ${count > 0 ? 'active' : ''}">
                        <div class="funnel-value">${count}</div>
                        <div class="funnel-label">${stage.replace(/_/g, ' ')}</div>
                        <div class="funnel-percentage">${percentage}%</div>
                    </div>
                `;
            }).join('');

            // Render funnel chart
            const ctx = document.getElementById('funnelChart').getContext('2d');
            if (charts.funnel) charts.funnel.destroy();

            charts.funnel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stages.map(s => s.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Sessions',
                        data: stageCounts,
                        backgroundColor: 'rgba(198, 126, 95, 0.5)',
                        borderColor: '#C67E5F',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderProductInsights() {
            // Product popularity
            const products = aggregatedMetrics.productPopularity || [];
            const productContainer = document.getElementById('productPopularity');

            if (products.length > 0) {
                const maxCount = Math.max(...products.map(p => p[1]));
                productContainer.innerHTML = products
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => `
                        <div class="popularity-item">
                            <span>${name}</span>
                            <div class="popularity-bar">
                                <div class="popularity-fill" style="width: ${(count / maxCount) * 100}%"></div>
                            </div>
                            <span>${count}</span>
                        </div>
                    `).join('');
            } else {
                productContainer.innerHTML = '<div class="no-data">No product data yet</div>';
            }

            // Fabric popularity
            const fabrics = aggregatedMetrics.fabricPopularity || [];
            const fabricContainer = document.getElementById('fabricPopularity');

            if (fabrics.length > 0) {
                const maxCount = Math.max(...fabrics.map(f => f[1]));
                fabricContainer.innerHTML = fabrics
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => `
                        <div class="popularity-item">
                            <span>${name}</span>
                            <div class="popularity-bar">
                                <div class="popularity-fill" style="width: ${(count / maxCount) * 100}%"></div>
                            </div>
                            <span>${count}</span>
                        </div>
                    `).join('');
            } else {
                fabricContainer.innerHTML = '<div class="no-data">No fabric data yet</div>';
            }

            // Usage heatmap
            const hourly = aggregatedMetrics.peakUsage?.hourly || new Array(24).fill(0);
            const maxUsage = Math.max(...hourly, 1);
            const heatmapContainer = document.getElementById('usageHeatmap');

            heatmapContainer.innerHTML = hourly.map((count, hour) => {
                let className = 'heatmap-cell';
                const percentage = (count / maxUsage) * 100;
                if (percentage > 75) className += ' very-high';
                else if (percentage > 50) className += ' high';
                else if (percentage > 25) className += ' medium';
                else if (percentage > 0) className += ' low';

                return `<div class="${className}" title="${hour}:00 - ${count} events">${hour}</div>`;
            }).join('');
        }

        function renderPriceSensitivity() {
            // Price ranges
            const ranges = aggregatedMetrics.priceSensitivity?.ranges || [];
            const rangeContainer = document.getElementById('priceRanges');

            if (ranges.length > 0) {
                rangeContainer.innerHTML = ranges
                    .sort((a, b) => {
                        const order = ['under-1500', '1500-2000', '2000-2500', '2500-3000', 'over-3000'];
                        return order.indexOf(a[0]) - order.indexOf(b[0]);
                    })
                    .map(([range, count]) => `
                        <div class="price-range-bar">
                            <span class="price-range-label">¬£${range.replace('-', ' - ¬£')}</span>
                            <div class="popularity-bar">
                                <div class="popularity-fill" style="width: ${(count / Math.max(...ranges.map(r => r[1]))) * 100}%"></div>
                            </div>
                            <span class="price-range-count">${count}</span>
                        </div>
                    `).join('');
            } else {
                rangeContainer.innerHTML = '<div class="no-data">No price range data yet</div>';
            }

            // Budget queries
            const budgetQueries = aggregatedMetrics.priceSensitivity?.budgetQueries || [];
            const budgetContainer = document.getElementById('budgetQueries');

            if (budgetQueries.length > 0) {
                budgetContainer.innerHTML = budgetQueries
                    .slice(-10)
                    .reverse()
                    .map(q => `
                        <div class="popularity-item">
                            <span>${q.query}</span>
                            <span style="font-weight: 600; color: #C67E5F;">¬£${q.budget}</span>
                        </div>
                    `).join('');
            } else {
                budgetContainer.innerHTML = '<div class="no-data">No budget queries yet</div>';
            }
        }

        function renderJourneys() {
            // Journey paths - simplified
            const paths = allEvents.filter(e => e.eventName === 'user_query')
                .reduce((acc, event) => {
                    const session = event.sessionId;
                    if (!acc[session]) acc[session] = [];
                    acc[session].push(event.data.query);
                    return acc;
                }, {});

            const pathContainer = document.getElementById('journeyPaths');
            const pathEntries = Object.entries(paths).slice(-5);

            if (pathEntries.length > 0) {
                pathContainer.innerHTML = pathEntries.map(([session, queries]) => `
                    <div class="journey-path">
                        ${queries.map(q => `<div class="journey-step">${q.substring(0, 30)}${q.length > 30 ? '...' : ''}</div>`).join('<span class="journey-arrow">‚Üí</span>')}
                    </div>
                `).join('');
            } else {
                pathContainer.innerHTML = '<div class="no-data">No journey paths yet</div>';
            }

            // Success metrics
            const timeToSuccess = aggregatedMetrics.userJourneys?.timeToSuccess || [];
            const successContainer = document.getElementById('successMetrics');

            if (timeToSuccess.length > 0) {
                const avgTime = timeToSuccess.reduce((a, b) => a + b.time, 0) / timeToSuccess.length / 1000;
                const avgQueries = timeToSuccess.reduce((a, b) => a + b.queryCount, 0) / timeToSuccess.length;

                successContainer.innerHTML = `
                    <div class="success-metric">
                        <h4>Average Time to Success: ${Math.round(avgTime)} seconds</h4>
                        <p>Average queries before success: ${avgQueries.toFixed(1)}</p>
                        <p>Total successful sessions: ${timeToSuccess.length}</p>
                    </div>
                `;
            } else {
                successContainer.innerHTML = '<div class="no-data">No success metrics yet</div>';
            }

            // Abandonments
            const abandonments = aggregatedMetrics.userJourneys?.abandonments || [];
            const abandonContainer = document.getElementById('abandonmentAnalysis');

            if (abandonments.length > 0) {
                abandonContainer.innerHTML = abandonments.slice(-5).reverse().map(a => `
                    <div class="abandonment-item">
                        <strong>Last query:</strong> ${a.lastQuery}<br>
                        <small>After ${a.queryCount} queries, ${Math.round(a.sessionDuration / 1000)}s session</small>
                    </div>
                `).join('');
            } else {
                abandonContainer.innerHTML = '<div class="no-data">No abandonment data yet</div>';
            }
        }

        function renderPerformance() {
            // Response time chart
            const responses = allEvents.filter(e => e.eventName === 'agent_response');
            if (responses.length > 0) {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                if (charts.performance) charts.performance.destroy();

                charts.performance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: responses.slice(-20).map((_, i) => i + 1),
                        datasets: [{
                            label: 'Response Time (ms)',
                            data: responses.slice(-20).map(r => r.data.responseTime),
                            borderColor: '#C67E5F',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Reformulation rate
            const reformulations = aggregatedMetrics.queryPatterns?.reformulations || [];
            const reformContainer = document.getElementById('reformulationRate');

            if (reformulations.length > 0) {
                const avgReformulations = reformulations.reduce((a, b) => a + b[1], 0) / reformulations.length;
                reformContainer.innerHTML = `
                    <div class="success-metric">
                        <h4>Average Reformulations per Session: ${avgReformulations.toFixed(1)}</h4>
                        <p>Sessions with reformulations: ${reformulations.length}</p>
                    </div>
                `;
            } else {
                reformContainer.innerHTML = '<div class="no-data">No reformulation data yet</div>';
            }
        }

        function renderIssues() {
            // Dead ends
            const deadEnds = aggregatedMetrics.queryPatterns?.deadEnds || [];
            const deadEndContainer = document.getElementById('deadEnds');

            if (deadEnds.length > 0) {
                deadEndContainer.innerHTML = deadEnds.slice(-10).reverse().map(d => `
                    <div class="dead-end-item">
                        <strong>Query:</strong> ${d.query}<br>
                        <small>No results returned</small>
                    </div>
                `).join('');
            } else {
                deadEndContainer.innerHTML = '<div class="no-data">No dead ends found (good!)</div>';
            }

            // Errors
            const errors = allEvents.filter(e => e.eventName === 'error_occurred').slice(-10);
            const errorContainer = document.getElementById('recentErrors');

            if (errors.length > 0) {
                errorContainer.innerHTML = errors.reverse().map(e => `
                    <div class="dead-end-item">
                        <strong>Type:</strong> ${e.data.errorType}<br>
                        <small>${JSON.stringify(e.data.errorDetails || 'No details')}</small>
                    </div>
                `).join('');
            } else {
                errorContainer.innerHTML = '<div class="no-data">No errors found (excellent!)</div>';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadData();
        }, 10000);

        // Initial load
        loadData();
    </script>
</body>
</html>