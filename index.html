<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofas and Stuff - Pricing Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load modern fonts for testing -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700&family=Urbanist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #FFF5EB 0%, #FFE4CC 50%, #FFD4A8 100%);
        }

        /* Beautiful heading font */
        h1, h2, h3, .heading-font {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* Full-screen chat layout */
        #chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        /* Smooth scroll for messages */
        #messages-container {
            scroll-behavior: smooth;
            background: transparent;
        }

        /* Hide scrollbar but keep functionality */
        #messages-container::-webkit-scrollbar {
            width: 6px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        #messages-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Typing indicator animation */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #fb923c;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Message fade-in animation */
        .message-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input area focus ring */
        #message-input:focus {
            outline: none;
            border-color: #fb923c;
            box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.15);
        }

        /* Send button hover effect */
        #send-button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Magical Glowing Orb Animation */
        .orb-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .orb {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            margin: -40px 0 0 -40px;
            border-radius: 50%;
            background: linear-gradient(135deg,
                #8B5CF6,  /* Vivid Purple */
                #EC4899,  /* Bright Pink */
                #F43F5E,  /* Rose */
                #FB923C,  /* Orange */
                #FBBF24,  /* Amber */
                #FACC15,  /* Yellow */
                #A3E635,  /* Lime */
                #22C55E,  /* Green */
                #10B981,  /* Emerald */
                #14B8A6,  /* Teal */
                #06B6D4,  /* Cyan */
                #0EA5E9,  /* Sky Blue */
                #3B82F6,  /* Blue */
                #6366F1,  /* Indigo */
                #8B5CF6,  /* Purple */
                #A855F7,  /* Violet */
                #C026D3,  /* Fuchsia */
                #E11D48,  /* Red */
                #F97316,  /* Deep Orange */
                #EAB308,  /* Gold */
                #84CC16,  /* Light Green */
                #8B5CF6   /* Back to Purple for smooth loop */
            );
            background-size: 2200% 2200%;
            animation: orbColorShift 15s ease-in-out infinite, orbFloat 3s ease-in-out infinite;
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.8);
        }

        .orb-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            margin: -50px 0 0 -50px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.6), transparent 70%);
            animation: orbPulse 2s ease-in-out infinite, glowColorShift 15s ease-in-out infinite;
        }

        .orb-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            margin: -60px 0 0 -60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.4), transparent 70%);
            animation: orbPulse 2s ease-in-out infinite 1s, glowColorShift 15s ease-in-out infinite 7.5s;
        }

        @keyframes glowColorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(360deg); }
        }

        @keyframes orbColorShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes orbFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        @keyframes orbPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.3); opacity: 0; }
        }

        /* Orb movement when typing starts */
        .orb-container.move-down {
            animation: moveToButton 0.6s ease-out forwards;
        }

        @keyframes moveToButton {
            to {
                transform: scale(0.4) translateY(300px);
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>
    <!-- Full-screen chat container -->
    <div id="chat-container">

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <div id="logo-container" class="w-12 h-12 rounded-3xl flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, #fb923c, #ea580c);">
                    <!-- Cute bubbly couch with happy face -->
                    <svg class="w-8 h-8" viewBox="0 0 48 48" fill="none">
                        <!-- Couch body (rounded/bubbly) -->
                        <path d="M8 22C8 20 9 18 11 18H13V14C13 12 14 10 16 10H32C34 10 35 12 35 14V18H37C39 18 40 20 40 22V30C40 32 39 34 37 34H35V36H33V34H15V36H13V34H11C9 34 8 32 8 30V22Z" fill="white" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <!-- Left armrest -->
                        <rect x="8" y="22" width="5" height="8" rx="2" fill="white"/>
                        <!-- Right armrest -->
                        <rect x="35" y="22" width="5" height="8" rx="2" fill="white"/>
                        <!-- Cute happy face -->
                        <circle id="logo-eye-left" cx="20" cy="20" r="1.5" fill="#fb923c"/>
                        <circle id="logo-eye-right" cx="28" cy="20" r="1.5" fill="#fb923c"/>
                        <path id="logo-smile" d="M20 25C20 25 22 27 24 27C26 27 28 25 28 25" stroke="#fb923c" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900" style="letter-spacing: -0.02em;">Sofas and Stuff</h1>
                    <p class="text-xs text-gray-600 font-light" style="letter-spacing: 0.02em;">Pricing Companion</p>
                </div>
            </div>
            <button id="new-conversation-btn" class="px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors duration-150 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span class="hidden sm:inline">New Conversation</span>
                <span class="sm:hidden">New</span>
            </button>
        </header>

        <!-- Messages Area (scrollable) -->
        <main id="messages-container" class="flex-1 overflow-y-auto px-4 py-8">
            <div class="max-w-3xl mx-auto">

                <!-- Welcome Message (shown when no messages) -->
                <div id="welcome-message" class="flex items-center justify-center" style="min-height: 60vh;">
                    <div class="text-center">
                        <!-- Magical glowing orb -->
                        <div id="magic-orb" class="mx-auto mb-8 relative">
                            <!-- Main glowing sphere -->
                            <div class="orb-container">
                                <div class="orb"></div>
                                <div class="orb-glow"></div>
                                <div class="orb-pulse"></div>
                            </div>
                        </div>

                        <!-- Subtle example questions below orb -->
                        <p id="example-question" class="text-sm text-gray-600 transition-opacity duration-500 max-w-md mx-auto px-4 font-light italic"></p>
                    </div>
                </div>

                <!-- Messages will be appended here -->
                <div id="messages-list"></div>

                <!-- Typing Indicator (hidden by default) -->
                <div id="typing-indicator" class="flex items-start gap-3 hidden message-fade-in mb-8">
                    <div class="w-8 h-8 bg-gradient-to-br rounded-full flex items-center justify-center flex-shrink-0 shadow-sm agent-avatar">
                        <svg class="w-5 h-5 text-white" viewBox="0 0 48 48" fill="none">
                            <path d="M8 22C8 20 9 18 11 18H13V14C13 12 14 10 16 10H32C34 10 35 12 35 14V18H37C39 18 40 20 40 22V30C40 32 39 34 37 34H35V36H33V34H15V36H13V34H11C9 34 8 32 8 30V22Z" fill="white" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="8" y="22" width="5" height="8" rx="2" fill="white"/>
                            <rect x="35" y="22" width="5" height="8" rx="2" fill="white"/>
                        </svg>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
                        <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Input Area (fixed at bottom) -->
        <footer class="bg-white border-t border-gray-200 px-4 py-4 shadow-lg">
            <div class="max-w-3xl mx-auto">
                <div class="flex gap-3 items-end">
                    <textarea
                        id="message-input"
                        rows="1"
                        placeholder="Ask about products, pricing, or options..."
                        class="flex-1 px-4 py-3 border rounded-xl resize-none focus:outline-none transition-all duration-150"
                        style="max-height: 150px; line-height: 1.5; min-height: 48px;"
                    ></textarea>
                    <button
                        id="send-button"
                        class="text-white rounded-xl shadow-md transition-all duration-150"
                        aria-label="Send message"
                        style="flex-shrink: 0; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #fb923c, #f97316);"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center font-light">
                    Session expires after 1 hour of inactivity
                </p>
            </div>
        </footer>

    </div>

    <script>
        // ========================================
        // CHAT UI JAVASCRIPT
        // ========================================

        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const messagesList = document.getElementById('messages-list');
        const welcomeMessage = document.getElementById('welcome-message');
        const typingIndicator = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const newConversationBtn = document.getElementById('new-conversation-btn');

        // Session Management
        let sessionId = null;
        let messageCount = 0;

        // Backend API URL (v2)
        const BACKEND_API_URL = 'https://europe-west2-sofa-project-v2.cloudfunctions.net/sofa-price-calculator-v2';

        // ========================================
        // RANDOM THEME SELECTION
        // ========================================

        const themes = {
            warmSunset: {
                name: 'Warm Sunset',
                bgGradient: 'linear-gradient(135deg, #FFF5EB 0%, #FFE4CC 50%, #FFD4A8 100%)',
                buttonGradient: 'linear-gradient(135deg, #fb923c, #f97316)',
                logoGradient: 'linear-gradient(135deg, #fb923c, #ea580c)',
                accentColor: '#fb923c',
                logoFaceColor: '#fb923c',
                inputBorderColor: '#fb923c',
                inputFocusShadow: 'rgba(251, 146, 60, 0.15)',
                userBubbleGradient: 'linear-gradient(135deg, #fb923c, #f97316)',
                agentAvatarGradient: 'linear-gradient(135deg, #fb923c, #ea580c)'
            },
            softLavender: {
                name: 'Soft Lavender',
                bgGradient: 'linear-gradient(135deg, #F8F7FF 0%, #F0EBFF 50%, #E8E0FF 100%)',
                buttonGradient: 'linear-gradient(135deg, #a855f7, #9333ea)',
                logoGradient: 'linear-gradient(135deg, #a855f7, #c026d3)',
                accentColor: '#a855f7',
                logoFaceColor: '#a855f7',
                inputBorderColor: '#a855f7',
                inputFocusShadow: 'rgba(168, 85, 247, 0.15)',
                userBubbleGradient: 'linear-gradient(135deg, #a855f7, #9333ea)',
                agentAvatarGradient: 'linear-gradient(135deg, #a855f7, #c026d3)'
            }
        };

        /**
         * Apply theme colors to all elements
         * Why: Ensures consistent theming across logo, button, and accents
         */
        function applyTheme(theme) {
            // Update background
            document.body.style.background = theme.bgGradient;

            // Update submit button
            const sendButton = document.getElementById('send-button');
            if (sendButton) {
                sendButton.style.background = theme.buttonGradient;
            }

            // Update logo container
            const logoContainer = document.getElementById('logo-container');
            if (logoContainer) {
                logoContainer.style.background = theme.logoGradient;
            }

            // Update logo face elements (eyes and smile)
            const eyeLeft = document.getElementById('logo-eye-left');
            const eyeRight = document.getElementById('logo-eye-right');
            const smile = document.getElementById('logo-smile');

            if (eyeLeft) eyeLeft.setAttribute('fill', theme.logoFaceColor);
            if (eyeRight) eyeRight.setAttribute('fill', theme.logoFaceColor);
            if (smile) smile.setAttribute('stroke', theme.logoFaceColor);

            // Update message input border
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.style.borderColor = theme.inputBorderColor;
            }

            // Update all agent avatars (messages and typing indicator)
            const agentAvatars = document.querySelectorAll('.agent-avatar');
            agentAvatars.forEach(avatar => {
                avatar.style.background = theme.agentAvatarGradient;
            });

            // Update typing indicator dots and input focus state
            const style = document.createElement('style');
            style.textContent = `
                .typing-dot { background: ${theme.accentColor} !important; }
                #message-input:focus {
                    border-color: ${theme.inputBorderColor} !important;
                    box-shadow: 0 0 0 3px ${theme.inputFocusShadow} !important;
                }
                .agent-avatar { background: ${theme.agentAvatarGradient} !important; }
            `;
            document.head.appendChild(style);

            console.log(`Theme applied: ${theme.name}`);
        }

        /**
         * Randomly select and apply theme on page load
         * Why: Provides variety while keeping just two beautiful options
         */
        function initializeRandomTheme() {
            const themeKeys = Object.keys(themes);
            const randomTheme = themes[themeKeys[Math.floor(Math.random() * themeKeys.length)]];
            applyTheme(randomTheme);
        }

        // Apply random theme on load
        initializeRandomTheme();

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        /**
         * Auto-resize textarea as user types
         * Why: Better UX for multi-line messages without manual resizing
         */
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        /**
         * Scroll to bottom of messages
         * Why: Always show latest message (like WhatsApp/ChatGPT)
         */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Show typing indicator
         * Why: Let user know agent is "thinking" (better perceived performance)
         */
        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        /**
         * Hide typing indicator
         */
        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        /**
         * Add message to chat UI
         * @param {string} content - Message text
         * @param {boolean} isUser - True if user message, false if agent
         * @param {object} data - Optional structured data (for product cards, etc.)
         */
        function addMessage(content, isUser, data = null) {
            // Hide welcome message on first message
            if (messageCount === 0) {
                welcomeMessage.classList.add('hidden');
            }
            messageCount++;

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'items-start', 'gap-3', 'message-fade-in', 'mb-8');

            if (isUser) {
                // User message (right side, dark slate gray)
                messageDiv.classList.add('flex-row-reverse');
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div class="bg-gradient-to-br from-slate-600 to-slate-700 text-white rounded-2xl rounded-tr-sm px-5 py-3 max-w-[85%] shadow-md">
                        <p class="text-sm leading-relaxed">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                // Agent message (left side, white with couch avatar)
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br rounded-full flex items-center justify-center flex-shrink-0 shadow-sm agent-avatar">
                        <svg class="w-5 h-5 text-white" viewBox="0 0 48 48" fill="none">
                            <path d="M8 22C8 20 9 18 11 18H13V14C13 12 14 10 16 10H32C34 10 35 12 35 14V18H37C39 18 40 20 40 22V30C40 32 39 34 37 34H35V36H33V34H15V36H13V34H11C9 34 8 32 8 30V22Z" fill="white" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="8" y="22" width="5" height="8" rx="2" fill="white"/>
                            <rect x="35" y="22" width="5" height="8" rx="2" fill="white"/>
                        </svg>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-5 py-3 max-w-[85%] shadow-md">
                        <p class="text-sm leading-relaxed text-gray-800" style="white-space: pre-wrap;">${escapeHtml(content)}</p>
                    </div>
                `;
            }

            messagesList.appendChild(messageDiv);
            scrollToBottom();
        }

        /**
         * Escape HTML to prevent XSS
         * Why: Security - never trust user input
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Send message to backend
         * Why: Main function for user interaction
         */
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message to UI
            addMessage(message, true);

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Disable input while processing
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Show typing indicator
            showTypingIndicator();

            try {
                // Check for greetings or casual queries first
                const lowerMessage = message.toLowerCase().trim();
                const greetings = ['hello', 'hi', 'hey', 'help', 'what can you do'];
                if (greetings.some(g => lowerMessage === g || lowerMessage.startsWith(g + ' '))) {
                    hideTypingIndicator();
                    addMessage(
                        "Hi! I'm your Sofas & Stuff pricing assistant. I can help you find prices for our products.\n\n" +
                        "Try asking me something like:\n" +
                        "â€¢ \"alwinton snuggler pacific\"\n" +
                        "â€¢ \"aldingbourne snuggler waves\"\n" +
                        "â€¢ \"rye snuggler pacific\"\n\n" +
                        "Format: product name + size + color",
                        false
                    );
                    return;
                }

                // Call real backend API
                const response = await fetch(`${BACKEND_API_URL}/getPrice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: message })
                });

                const data = await response.json();
                hideTypingIndicator();

                // Handle response
                if (response.ok && data.price) {
                    // Success - format the price response
                    const responseText = formatPriceResponse(data);
                    addMessage(responseText, false);
                } else if (data.error) {
                    // Error from backend - provide helpful guidance
                    let helpfulError = "I couldn't find that exact product.\n\n";

                    // Check if it might be a typo
                    if (lowerMessage.length > 3) {
                        helpfulError += "ðŸ’¡ Try:\n" +
                            "â€¢ Check spelling (e.g., 'Alwinton' not 'Alwington')\n" +
                            "â€¢ Include size (e.g., '3 seater', 'snuggler', 'corner')\n" +
                            "â€¢ Include fabric/color (e.g., 'pacific', 'waves', 'velvet')\n\n";
                    }

                    helpfulError += "Popular products: Alwinton, Aldingbourne, Stockbridge, Saltdean";

                    addMessage(helpfulError, false);
                } else {
                    // Unexpected response
                    addMessage(
                        "Hmm, I'm not sure about that.\n\n" +
                        "I work best when you give me:\n" +
                        "â€¢ Product name (e.g., Alwinton)\n" +
                        "â€¢ Size (e.g., 3 seater, snuggler)\n" +
                        "â€¢ Fabric (e.g., Sussex Plain, Velvet)",
                        false
                    );
                }

            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                addMessage('Sorry, I encountered a connection error. Please try again.', false);
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        /**
         * Format price response from backend into friendly message
         * Why: Make API response readable for sales staff
         */
        function formatPriceResponse(data) {
            // If no price found, return error message
            if (!data.price) {
                return "I couldn't find pricing for that. Could you try specifying the product, size, and fabric?";
            }

            let response = '';

            // Product name and price
            if (data.productName && data.price) {
                response = `${data.productName}\n`;
                response += `ðŸ’· Price: ${data.price}`;
            }

            // Add old price if on sale
            if (data.oldPrice) {
                response += ` (was ${data.oldPrice})`;
            }

            // Add fabric info
            if (data.fabricName) {
                response += `\n\nðŸŽ¨ Fabric: ${data.fabricName}`;
            }

            // Add fabric tier if available
            if (data.fabricDetails && data.fabricDetails.tier) {
                response += ` (${data.fabricDetails.tier})`;
            }

            return response;
        }

        /**
         * Start new conversation
         * Why: Sales staff need to start fresh for new customers
         */
        function startNewConversation() {
            if (messageCount > 0 && !confirm('Start a new conversation? Current chat will be cleared.')) {
                return;
            }

            // Clear messages
            messagesList.innerHTML = '';
            messageCount = 0;

            // Show welcome message
            welcomeMessage.classList.remove('hidden');

            // Reset session
            sessionId = null;

            // Reset orb animation state
            hasStartedTyping = false;
            const orbContainer = document.querySelector('.orb-container');
            if (orbContainer) {
                orbContainer.classList.remove('move-down');
            }

            // Restart orb animation
            startOrbAnimation();

            // Focus input
            messageInput.focus();
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Send button click
        sendButton.addEventListener('click', sendMessage);

        // Enter key to send (Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // New conversation button
        newConversationBtn.addEventListener('click', startNewConversation);

        // Focus input on page load
        document.addEventListener('DOMContentLoaded', function() {
            messageInput.focus();
            startOrbAnimation();
        });

        // ========================================
        // MAGICAL ORB & QUESTION ANIMATION
        // ========================================

        /**
         * Cycle through example questions with fade effect
         * Why: Shows users what they can ask in a subtle, elegant way
         */
        const exampleQuestions = [
            "What's the price for Alwinton in House Wool?",
            "Show me all options for Berkeley sofa",
            "Compare Alwinton vs Aldingbourne",
            "What 3-seaters are under Â£3000?",
            "Find me fabrics in sage green",
            "Which sofas come in velvet?",
            "Show me corner sofas under Â£4000"
        ];

        let questionIndex = 0;
        let questionInterval;
        let hasStartedTyping = false;

        function cycleQuestions() {
            const exampleQuestionEl = document.getElementById('example-question');
            if (!exampleQuestionEl) return;

            // Fade out
            exampleQuestionEl.style.opacity = '0';

            setTimeout(() => {
                // Change text
                exampleQuestionEl.textContent = exampleQuestions[questionIndex];
                questionIndex = (questionIndex + 1) % exampleQuestions.length;

                // Fade in
                exampleQuestionEl.style.opacity = '1';
            }, 500);
        }

        function startOrbAnimation() {
            // Only animate if welcome message is visible
            if (!welcomeMessage.classList.contains('hidden')) {
                // Start with first question
                const exampleQuestionEl = document.getElementById('example-question');
                if (exampleQuestionEl) {
                    exampleQuestionEl.textContent = exampleQuestions[0];
                    exampleQuestionEl.style.opacity = '1';
                }

                // Cycle questions every 3 seconds
                questionInterval = setInterval(cycleQuestions, 3000);
            }
        }

        /**
         * Animate orb down to submit button when user starts typing
         * Why: Creates magical transition from welcome to chat mode
         */
        function moveOrbDown() {
            if (hasStartedTyping) return;
            hasStartedTyping = true;

            const orbContainer = document.querySelector('.orb-container');
            const exampleQuestionEl = document.getElementById('example-question');

            if (orbContainer) {
                orbContainer.classList.add('move-down');
            }

            if (exampleQuestionEl) {
                exampleQuestionEl.style.opacity = '0';
            }

            // Stop cycling questions
            if (questionInterval) {
                clearInterval(questionInterval);
            }
        }

        // Trigger orb animation when user starts typing
        messageInput.addEventListener('input', function() {
            if (this.value.length === 1 && !hasStartedTyping) {
                moveOrbDown();
            }
        });

        messageInput.addEventListener('focus', function() {
            // Don't move orb on focus, only on actual typing
        });

    </script>
</body>
</html>
