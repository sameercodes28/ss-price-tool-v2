<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry Dashboard - British Made AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f3;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .events-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #C67E5F;
            color: #C67E5F;
        }

        .filter-btn.active {
            background: #C67E5F;
            color: white;
            border-color: #C67E5F;
        }

        .events-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .event-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .event-item:hover {
            background: #fafafa;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .event-type {
            font-weight: 600;
            color: #1a1a1a;
        }

        .event-time {
            font-size: 12px;
            color: #999;
        }

        .event-data {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .event-data strong {
            color: #333;
        }

        .feedback-positive {
            background: #dcfce7;
            border-left: 3px solid #22c55e;
        }

        .feedback-negative {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
        }

        .refresh-btn {
            background: #C67E5F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #b56d4e;
        }

        .export-btn {
            background: #8B9A7B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 12px;
        }

        .export-btn:hover {
            background: #7a896a;
        }

        .clear-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 12px;
        }

        .clear-btn:hover {
            background: #dc2626;
        }

        .query-highlight {
            background: #fef3c7;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }

        .price-highlight {
            background: #d1fae5;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .session-info {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 12px;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .feedback-stats {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }

        .feedback-stat {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
        }

        .feedback-stat.positive {
            background: #dcfce7;
        }

        .feedback-stat.negative {
            background: #fee2e2;
        }

        .top-queries {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .query-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .query-text {
            flex: 1;
            color: #333;
        }

        .query-count {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üìä Telemetry Dashboard</h1>
        <p>Analytics for British Made AI - Real-time user interaction tracking</p>
        <div style="margin-top: 16px;">
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="export-btn" onclick="exportData()">üì• Export JSON</button>
            <button class="clear-btn" onclick="clearData()">üóëÔ∏è Clear All Data</button>
        </div>
    </div>

    <div class="stats-grid" id="statsGrid">
        <!-- Stats will be populated here -->
    </div>

    <div class="chart-container">
        <div class="chart-title">üìà Feedback Summary</div>
        <div class="feedback-stats" id="feedbackStats">
            <!-- Feedback stats will be populated here -->
        </div>
    </div>

    <div class="top-queries">
        <div class="chart-title">üîç Top Queries</div>
        <div id="topQueries">
            <!-- Top queries will be populated here -->
        </div>
    </div>

    <div class="events-container">
        <h2 style="margin-bottom: 16px;">üìã Event Stream</h2>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterEvents('all')">All Events</button>
            <button class="filter-btn" onclick="filterEvents('user_query')">Queries</button>
            <button class="filter-btn" onclick="filterEvents('agent_response')">Responses</button>
            <button class="filter-btn" onclick="filterEvents('response_feedback')">Feedback</button>
            <button class="filter-btn" onclick="filterEvents('page_load')">Sessions</button>
        </div>
        <div class="events-list" id="eventsList">
            <!-- Events will be populated here -->
        </div>
    </div>

    <script>
        let allEvents = [];
        let currentFilter = 'all';

        function loadData() {
            const stored = localStorage.getItem('analyticsEvents');
            allEvents = stored ? JSON.parse(stored) : [];
            renderDashboard();
        }

        function refreshData() {
            loadData();
            showNotification('Data refreshed');
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all telemetry data? This cannot be undone.')) {
                localStorage.removeItem('analyticsEvents');
                localStorage.removeItem('sessionId');
                allEvents = [];
                renderDashboard();
                showNotification('All data cleared');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(allEvents, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telemetry-export-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported');
        }

        function renderDashboard() {
            renderStats();
            renderFeedbackStats();
            renderTopQueries();
            renderEvents();
        }

        function renderStats() {
            const stats = calculateStats();
            const statsGrid = document.getElementById('statsGrid');

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Events</h3>
                    <div class="stat-value">${stats.totalEvents}</div>
                    <div class="stat-label">All tracked interactions</div>
                </div>
                <div class="stat-card">
                    <h3>User Queries</h3>
                    <div class="stat-value">${stats.queries}</div>
                    <div class="stat-label">Questions asked</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Sessions</h3>
                    <div class="stat-value">${stats.sessions}</div>
                    <div class="stat-label">Individual users</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Session Time</h3>
                    <div class="stat-value">${stats.avgSessionTime}</div>
                    <div class="stat-label">Minutes on site</div>
                </div>
                <div class="stat-card">
                    <h3>Feedback Given</h3>
                    <div class="stat-value">${stats.feedbackCount}</div>
                    <div class="stat-label">Response ratings</div>
                </div>
                <div class="stat-card">
                    <h3>Satisfaction Rate</h3>
                    <div class="stat-value">${stats.satisfactionRate}%</div>
                    <div class="stat-label">Positive feedback</div>
                </div>
            `;
        }

        function calculateStats() {
            const sessions = new Set(allEvents.map(e => e.sessionId));
            const queries = allEvents.filter(e => e.eventName === 'user_query').length;
            const feedbackEvents = allEvents.filter(e => e.eventName === 'response_feedback');
            const positiveFeedback = feedbackEvents.filter(e => e.data.feedback === 'positive').length;

            // Calculate average session time
            const sessionTimes = [];
            sessions.forEach(sessionId => {
                const sessionEvents = allEvents.filter(e => e.sessionId === sessionId);
                if (sessionEvents.length > 0) {
                    const startEvent = sessionEvents.find(e => e.eventName === 'page_load');
                    const endEvent = sessionEvents.find(e => e.eventName === 'session_end');
                    if (startEvent && endEvent && endEvent.data.duration) {
                        sessionTimes.push(endEvent.data.duration);
                    }
                }
            });

            const avgTime = sessionTimes.length > 0
                ? Math.round(sessionTimes.reduce((a, b) => a + b, 0) / sessionTimes.length / 60000)
                : 0;

            return {
                totalEvents: allEvents.length,
                queries,
                sessions: sessions.size,
                avgSessionTime: avgTime || '< 1',
                feedbackCount: feedbackEvents.length,
                satisfactionRate: feedbackEvents.length > 0
                    ? Math.round((positiveFeedback / feedbackEvents.length) * 100)
                    : 0
            };
        }

        function renderFeedbackStats() {
            const feedbackEvents = allEvents.filter(e => e.eventName === 'response_feedback');
            const positive = feedbackEvents.filter(e => e.data.feedback === 'positive').length;
            const negative = feedbackEvents.filter(e => e.data.feedback === 'negative').length;

            document.getElementById('feedbackStats').innerHTML = `
                <div class="feedback-stat positive">
                    <div style="font-size: 24px; margin-bottom: 4px;">üëç</div>
                    <div style="font-size: 28px; font-weight: bold;">${positive}</div>
                    <div style="font-size: 12px; color: #666;">Positive</div>
                </div>
                <div class="feedback-stat negative">
                    <div style="font-size: 24px; margin-bottom: 4px;">üëé</div>
                    <div style="font-size: 28px; font-weight: bold;">${negative}</div>
                    <div style="font-size: 12px; color: #666;">Negative</div>
                </div>
            `;
        }

        function renderTopQueries() {
            const queries = allEvents.filter(e => e.eventName === 'user_query');
            const queryCount = {};

            queries.forEach(q => {
                const query = q.data.query;
                queryCount[query] = (queryCount[query] || 0) + 1;
            });

            const topQueries = Object.entries(queryCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const container = document.getElementById('topQueries');

            if (topQueries.length === 0) {
                container.innerHTML = '<div class="no-events">No queries yet</div>';
                return;
            }

            container.innerHTML = topQueries.map(([query, count]) => `
                <div class="query-item">
                    <div class="query-text">${escapeHtml(query)}</div>
                    <div class="query-count">${count}x</div>
                </div>
            `).join('');
        }

        function renderEvents() {
            const filtered = currentFilter === 'all'
                ? allEvents
                : allEvents.filter(e => e.eventName === currentFilter);

            const eventsList = document.getElementById('eventsList');

            if (filtered.length === 0) {
                eventsList.innerHTML = '<div class="no-events">No events to display</div>';
                return;
            }

            // Sort by timestamp descending
            const sorted = [...filtered].sort((a, b) => b.timestamp - a.timestamp);

            eventsList.innerHTML = sorted.map(event => {
                let extraClass = '';
                if (event.eventName === 'response_feedback') {
                    extraClass = event.data.feedback === 'positive' ? 'feedback-positive' : 'feedback-negative';
                }

                return `
                    <div class="event-item ${extraClass}">
                        <div class="event-header">
                            <span class="event-type">${getEventLabel(event.eventName)}</span>
                            <span class="event-time">${formatTime(event.timestamp)}</span>
                        </div>
                        <div class="event-data">
                            ${formatEventData(event)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getEventLabel(eventName) {
            const labels = {
                'page_load': 'üåê Page Load',
                'user_query': 'üí¨ User Query',
                'agent_response': 'ü§ñ Agent Response',
                'response_feedback': 'üìä Feedback',
                'session_end': 'üëã Session End'
            };
            return labels[eventName] || eventName;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) {
                return 'Just now';
            } else if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} min${mins > 1 ? 's' : ''} ago`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleString();
            }
        }

        function formatEventData(event) {
            const data = event.data;
            let html = '';

            switch (event.eventName) {
                case 'user_query':
                    html = `
                        <div class="query-highlight">${escapeHtml(data.query)}</div>
                        <div style="margin-top: 8px;">
                            <strong>Source:</strong> ${data.source} |
                            <strong>Length:</strong> ${data.queryLength} chars
                        </div>
                    `;
                    break;

                case 'agent_response':
                    html = `
                        <strong>Response Time:</strong> ${data.responseTime}ms<br>
                        <strong>Features:</strong> ${data.hasPrice ? 'üí∑ Price' : ''}
                        ${data.hasFeatures ? '‚ú® Features' : ''}
                        ${data.hasOpportunities ? 'üéØ Opportunities' : ''}
                    `;
                    break;

                case 'response_feedback':
                    const icon = data.feedback === 'positive' ? 'üëç' : 'üëé';
                    html = `
                        <strong>Rating:</strong> ${icon} ${data.feedback}<br>
                        <strong>Response Preview:</strong><br>
                        <div style="margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                            ${escapeHtml(data.responseContent ? data.responseContent.substring(0, 200) : 'N/A')}...
                        </div>
                    `;
                    if (data.screenshot && data.screenshot.prices) {
                        html += `<br><strong>Prices shown:</strong> ${data.screenshot.prices.map(p => `<span class="price-highlight">${p}</span>`).join(', ')}`;
                    }
                    break;

                case 'page_load':
                    html = `
                        <strong>URL:</strong> ${data.url}<br>
                        <strong>Screen:</strong> ${data.screenResolution}<br>
                        <strong>Viewport:</strong> ${data.viewport}
                    `;
                    break;

                case 'session_end':
                    const duration = Math.round(data.duration / 60000);
                    html = `
                        <strong>Duration:</strong> ${duration} minutes<br>
                        <strong>Events:</strong> ${data.eventCount}
                    `;
                    break;

                default:
                    html = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }

            if (event.sessionId) {
                html += `<div class="session-info">Session: ${event.sessionId}</div>`;
            }

            return html;
        }

        function filterEvents(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderEvents();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadData();
        }, 10000);

        // Initial load
        loadData();
    </script>
</body>
</html>