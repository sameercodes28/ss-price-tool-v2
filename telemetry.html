<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Telemetry Dashboard - British Made AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f3;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: #666;
        }

        .health-status {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .health-indicator.healthy {
            background: #dcfce7;
            color: #16a34a;
        }

        .health-indicator.unhealthy {
            background: #fee2e2;
            color: #dc2626;
        }

        .health-indicator.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #22c55e;
        }

        .status-dot.red {
            background: #ef4444;
        }

        .status-dot.yellow {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card.alert {
            border-left: 4px solid #ef4444;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
        }

        .stat-change.positive {
            background: #dcfce7;
            color: #16a34a;
        }

        .stat-change.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .metric-item {
            text-align: center;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .feedback-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feedback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feedback-item {
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
        }

        .feedback-item.positive {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .feedback-item.negative {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .feedback-type {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-time {
            font-size: 12px;
            color: #999;
        }

        .feedback-query {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 14px;
            color: #333;
        }

        .feedback-price {
            margin-top: 8px;
            font-weight: 600;
            color: #C67E5F;
        }

        .events-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #C67E5F;
            color: #C67E5F;
        }

        .filter-btn.active {
            background: #C67E5F;
            color: white;
            border-color: #C67E5F;
        }

        .events-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .event-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .event-item:hover {
            background: #fafafa;
        }

        .error-event {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
        }

        .success-event {
            background: #f0fdf4;
            border-left: 3px solid #22c55e;
        }

        .refresh-btn {
            background: #C67E5F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #b56d4e;
        }

        .export-btn {
            background: #8B9A7B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 12px;
        }

        .clear-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 12px;
        }

        .response-time-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .time-bar {
            flex: 1;
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
        }

        .time-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #f59e0b 50%, #ef4444 100%);
            transition: width 0.3s;
        }

        .time-label {
            font-size: 12px;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üéØ Enhanced Telemetry Dashboard</h1>
        <p>Real-time health monitoring, performance metrics, and user experience tracking</p>

        <div class="health-status">
            <div class="health-indicator" id="priceStatus">
                <span class="status-dot"></span>
                <span>Price API</span>
                <span class="response-time"></span>
            </div>
            <div class="health-indicator" id="chatStatus">
                <span class="status-dot"></span>
                <span>Chat API</span>
                <span class="response-time"></span>
            </div>
            <div class="health-indicator" id="overallHealth">
                <span class="status-dot"></span>
                <span>Overall Health</span>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="export-btn" onclick="exportData()">üì• Export JSON</button>
            <button class="clear-btn" onclick="clearData()">üóëÔ∏è Clear All Data</button>
        </div>
    </div>

    <div class="stats-grid" id="statsGrid">
        <!-- Stats will be populated here -->
    </div>

    <!-- Usage Over Time Chart -->
    <div class="chart-container">
        <div class="chart-title">üìà Usage Over Time (Last 7 Days)</div>
        <div class="chart-wrapper">
            <canvas id="usageChart"></canvas>
        </div>
    </div>

    <!-- Response Time Performance -->
    <div class="chart-container">
        <div class="chart-title">‚ö° Response Time Distribution</div>
        <div class="chart-wrapper">
            <canvas id="responseTimeChart"></canvas>
        </div>
        <div class="performance-metrics" id="performanceMetrics">
            <!-- Performance metrics will be populated here -->
        </div>
    </div>

    <!-- Feedback Section -->
    <div class="feedback-section">
        <div class="chart-title">üëçüëé Recent Feedback</div>
        <div class="feedback-grid" id="feedbackGrid">
            <!-- Feedback items will be populated here -->
        </div>
    </div>

    <!-- Events Stream -->
    <div class="events-container">
        <h2 style="margin-bottom: 16px;">üìä Event Stream</h2>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterEvents('all')">All Events</button>
            <button class="filter-btn" onclick="filterEvents('user_query')">Queries</button>
            <button class="filter-btn" onclick="filterEvents('agent_response')">Responses</button>
            <button class="filter-btn" onclick="filterEvents('response_feedback')">Feedback</button>
            <button class="filter-btn" onclick="filterEvents('error_occurred')">Errors</button>
            <button class="filter-btn" onclick="filterEvents('health_check')">Health</button>
        </div>
        <div class="events-list" id="eventsList">
            <!-- Events will be populated here -->
        </div>
    </div>

    <script>
        // Check authentication
        const AUTH_KEY = 'britishmade_authenticated';
        const isAuthenticated = sessionStorage.getItem(AUTH_KEY);

        if (!isAuthenticated || isAuthenticated !== 'true') {
            window.location.href = '/';
        }

        let allEvents = [];
        let currentFilter = 'all';
        let usageChart = null;
        let responseTimeChart = null;

        function loadData() {
            const stored = localStorage.getItem('analyticsEvents');
            allEvents = stored ? JSON.parse(stored) : [];
            renderDashboard();
        }

        function refreshData() {
            loadData();
            showNotification('Data refreshed');
        }

        function clearData() {
            if (confirm('Clear all telemetry data? This cannot be undone.')) {
                localStorage.removeItem('analyticsEvents');
                allEvents = [];
                renderDashboard();
                showNotification('All data cleared');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(allEvents, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telemetry-export-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported');
        }

        function renderDashboard() {
            renderHealthStatus();
            renderStats();
            renderUsageChart();
            renderResponseTimeChart();
            renderFeedback();
            renderEvents();
        }

        function renderHealthStatus() {
            // Get latest health check
            const healthChecks = allEvents.filter(e => e.eventName === 'health_check');
            if (healthChecks.length > 0) {
                const latest = healthChecks[healthChecks.length - 1];

                // Update Price API status
                const priceStatus = document.getElementById('priceStatus');
                if (latest.data.checks && latest.data.checks.priceEndpoint) {
                    updateHealthIndicator(priceStatus, latest.data.checks.priceEndpoint);
                }

                // Update Chat API status
                const chatStatus = document.getElementById('chatStatus');
                if (latest.data.checks && latest.data.checks.chatEndpoint) {
                    updateHealthIndicator(chatStatus, latest.data.checks.chatEndpoint);
                }

                // Overall health
                const overallHealth = document.getElementById('overallHealth');
                const allHealthy = latest.data.checks &&
                    latest.data.checks.priceEndpoint?.status === 'healthy' &&
                    latest.data.checks.chatEndpoint?.status === 'healthy';

                updateHealthIndicator(overallHealth, {
                    status: allHealthy ? 'healthy' : 'unhealthy'
                });
            }
        }

        function updateHealthIndicator(element, data) {
            const dot = element.querySelector('.status-dot');
            const responseTime = element.querySelector('.response-time');

            element.classList.remove('healthy', 'unhealthy', 'warning');
            dot.classList.remove('green', 'red', 'yellow');

            if (data.status === 'healthy') {
                element.classList.add('healthy');
                dot.classList.add('green');
                if (responseTime && data.responseTime) {
                    responseTime.textContent = `${data.responseTime}ms`;
                }
            } else if (data.status === 'unhealthy' || data.status === 'error') {
                element.classList.add('unhealthy');
                dot.classList.add('red');
                if (responseTime) {
                    responseTime.textContent = 'Error';
                }
            } else {
                element.classList.add('warning');
                dot.classList.add('yellow');
            }
        }

        function renderStats() {
            const stats = calculateStats();
            const statsGrid = document.getElementById('statsGrid');

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Events</h3>
                    <div class="stat-value">${stats.totalEvents}</div>
                    <div class="stat-label">All tracked interactions</div>
                </div>
                <div class="stat-card">
                    <h3>User Queries</h3>
                    <div class="stat-value">${stats.queries}</div>
                    <div class="stat-label">Questions asked</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Response Time</h3>
                    <div class="stat-value">${stats.avgResponseTime}ms</div>
                    <div class="stat-label">Average wait time</div>
                </div>
                <div class="stat-card ${stats.errorRate > 5 ? 'alert' : ''}">
                    <h3>Error Rate</h3>
                    <div class="stat-value">${stats.errorRate}%</div>
                    <div class="stat-label">Failed requests</div>
                </div>
                <div class="stat-card">
                    <h3>Feedback Score</h3>
                    <div class="stat-value">${stats.satisfactionRate}%</div>
                    <div class="stat-label">Positive feedback</div>
                    <div class="stat-change ${stats.feedbackCount > 0 ? 'positive' : ''}">
                        ${stats.positiveFeedback} üëç / ${stats.negativeFeedback} üëé
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Response Quality</h3>
                    <div class="stat-value">${stats.avgCompleteness}%</div>
                    <div class="stat-label">Avg completeness score</div>
                </div>
            `;
        }

        function calculateStats() {
            const queries = allEvents.filter(e => e.eventName === 'user_query');
            const responses = allEvents.filter(e => e.eventName === 'agent_response');
            const feedbackEvents = allEvents.filter(e => e.eventName === 'response_feedback');
            const errors = allEvents.filter(e => e.eventName === 'error_occurred');

            const positiveFeedback = feedbackEvents.filter(e => e.data.feedback === 'positive').length;
            const negativeFeedback = feedbackEvents.filter(e => e.data.feedback === 'negative').length;

            // Calculate average response time
            const responseTimes = responses.map(r => r.data.responseTime).filter(t => t);
            const avgResponseTime = responseTimes.length > 0
                ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length)
                : 0;

            // Calculate average completeness
            const completenessScores = responses.map(r => r.data.responseCompleteness).filter(s => s !== undefined);
            const avgCompleteness = completenessScores.length > 0
                ? Math.round(completenessScores.reduce((a, b) => a + b, 0) / completenessScores.length)
                : 0;

            return {
                totalEvents: allEvents.length,
                queries: queries.length,
                avgResponseTime,
                errorRate: queries.length > 0 ? Math.round((errors.length / queries.length) * 100) : 0,
                satisfactionRate: feedbackEvents.length > 0
                    ? Math.round((positiveFeedback / feedbackEvents.length) * 100)
                    : 0,
                positiveFeedback,
                negativeFeedback,
                feedbackCount: feedbackEvents.length,
                avgCompleteness
            };
        }

        function renderUsageChart() {
            const ctx = document.getElementById('usageChart').getContext('2d');

            // Group events by day
            const dailyData = {};
            const now = new Date();

            // Initialize last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dailyData[dateStr] = { queries: 0, responses: 0, feedback: 0 };
            }

            // Count events per day
            allEvents.forEach(event => {
                const date = new Date(event.timestamp).toISOString().split('T')[0];
                if (dailyData[date]) {
                    if (event.eventName === 'user_query') dailyData[date].queries++;
                    if (event.eventName === 'agent_response') dailyData[date].responses++;
                    if (event.eventName === 'response_feedback') dailyData[date].feedback++;
                }
            });

            const labels = Object.keys(dailyData).map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
            });

            if (usageChart) usageChart.destroy();

            usageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Queries',
                            data: Object.values(dailyData).map(d => d.queries),
                            borderColor: '#C67E5F',
                            backgroundColor: 'rgba(198, 126, 95, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Responses',
                            data: Object.values(dailyData).map(d => d.responses),
                            borderColor: '#8B9A7B',
                            backgroundColor: 'rgba(139, 154, 123, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Feedback',
                            data: Object.values(dailyData).map(d => d.feedback),
                            borderColor: '#7A6B5D',
                            backgroundColor: 'rgba(122, 107, 93, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderResponseTimeChart() {
            const ctx = document.getElementById('responseTimeChart').getContext('2d');

            const responses = allEvents.filter(e => e.eventName === 'agent_response');
            const responseTimes = responses.map(r => r.data.responseTime).filter(t => t).sort((a, b) => a - b);

            if (responseTimes.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="no-data">No response time data yet</div>';
                return;
            }

            // Calculate percentiles
            const p50 = responseTimes[Math.floor(responseTimes.length * 0.5)];
            const p90 = responseTimes[Math.floor(responseTimes.length * 0.9)];
            const p99 = responseTimes[Math.floor(responseTimes.length * 0.99)] || p90;

            // Bucket response times
            const buckets = [0, 500, 1000, 2000, 3000, 5000, 10000];
            const bucketCounts = new Array(buckets.length - 1).fill(0);

            responseTimes.forEach(time => {
                for (let i = 0; i < buckets.length - 1; i++) {
                    if (time >= buckets[i] && time < buckets[i + 1]) {
                        bucketCounts[i]++;
                        break;
                    }
                }
            });

            if (responseTimeChart) responseTimeChart.destroy();

            responseTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: buckets.slice(0, -1).map((b, i) => `${b}-${buckets[i+1]}ms`),
                    datasets: [{
                        label: 'Response Count',
                        data: bucketCounts,
                        backgroundColor: '#C67E5F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Show percentiles
            document.getElementById('performanceMetrics').innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${p50}ms</div>
                    <div class="metric-label">P50 (Median)</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${p90}ms</div>
                    <div class="metric-label">P90</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${p99}ms</div>
                    <div class="metric-label">P99</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${responseTimes.length}</div>
                    <div class="metric-label">Total Responses</div>
                </div>
            `;
        }

        function renderFeedback() {
            const feedbackEvents = allEvents.filter(e => e.eventName === 'response_feedback')
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);

            const feedbackGrid = document.getElementById('feedbackGrid');

            if (feedbackEvents.length === 0) {
                feedbackGrid.innerHTML = '<div class="no-data">No feedback yet</div>';
                return;
            }

            feedbackGrid.innerHTML = feedbackEvents.map(event => {
                const isPositive = event.data.feedback === 'positive';
                const icon = isPositive ? 'üëç' : 'üëé';

                // Get the associated query
                const queries = allEvents.filter(e =>
                    e.eventName === 'user_query' &&
                    e.timestamp < event.timestamp
                ).sort((a, b) => b.timestamp - a.timestamp);
                const lastQuery = queries[0]?.data.query || 'Unknown query';

                return `
                    <div class="feedback-item ${isPositive ? 'positive' : 'negative'}">
                        <div class="feedback-header">
                            <span class="feedback-type">
                                ${icon} ${isPositive ? 'Positive' : 'Negative'} Feedback
                            </span>
                            <span class="feedback-time">${formatTime(event.timestamp)}</span>
                        </div>
                        <div class="feedback-query">Query: ${escapeHtml(lastQuery)}</div>
                        ${event.data.screenshot && event.data.screenshot.prices ?
                            `<div class="feedback-price">Prices shown: ${event.data.screenshot.prices.join(', ')}</div>` : ''}
                        ${!isPositive ? '<div style="margin-top: 8px; color: #dc2626; font-size: 12px;">‚ö†Ô∏è Review this response for accuracy</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderEvents() {
            const filtered = currentFilter === 'all'
                ? allEvents
                : allEvents.filter(e => e.eventName === currentFilter);

            const eventsList = document.getElementById('eventsList');

            if (filtered.length === 0) {
                eventsList.innerHTML = '<div class="no-data">No events to display</div>';
                return;
            }

            const sorted = [...filtered].sort((a, b) => b.timestamp - a.timestamp).slice(0, 100);

            eventsList.innerHTML = sorted.map(event => {
                let extraClass = '';
                if (event.eventName === 'error_occurred') extraClass = 'error-event';
                if (event.eventName === 'high_quality_response') extraClass = 'success-event';

                return `
                    <div class="event-item ${extraClass}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong>${getEventLabel(event.eventName)}</strong>
                            <span style="color: #999; font-size: 12px;">${formatTime(event.timestamp)}</span>
                        </div>
                        ${formatEventData(event)}
                    </div>
                `;
            }).join('');
        }

        function getEventLabel(eventName) {
            const labels = {
                'page_load': 'üåê Page Load',
                'user_query': 'üí¨ User Query',
                'agent_response': 'ü§ñ Agent Response',
                'response_feedback': 'üìä Feedback',
                'error_occurred': '‚ùå Error',
                'health_check': 'üè• Health Check',
                'high_quality_response': '‚≠ê High Quality Response',
                'low_quality_response': '‚ö†Ô∏è Low Quality Response',
                'query_intent': 'üéØ Query Intent',
                'access_granted': 'üîì Access Granted',
                'access_denied': 'üîí Access Denied'
            };
            return labels[eventName] || eventName;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleString();
        }

        function formatEventData(event) {
            const data = event.data;
            let html = '';

            switch (event.eventName) {
                case 'user_query':
                    html = `
                        <div style="background: #f9f9f9; padding: 8px; border-radius: 4px;">
                            ${escapeHtml(data.query)}
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            Source: ${data.source} | Depth: Query #${data.sessionDepth || 1}
                        </div>
                    `;
                    break;

                case 'agent_response':
                    const timeBar = Math.min((data.responseTime / 5000) * 100, 100);
                    html = `
                        <div class="response-time-bar">
                            <span class="time-label">${data.responseTime}ms</span>
                            <div class="time-bar">
                                <div class="time-bar-fill" style="width: ${timeBar}%"></div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px;">
                            Completeness: ${data.responseCompleteness}% |
                            ${data.hasPrice ? '‚úì Price' : '‚úó Price'} |
                            ${data.hasFeatures ? '‚úì Features' : '‚úó Features'} |
                            ${data.hasOpportunities ? '‚úì Opportunities' : '‚úó Opportunities'}
                        </div>
                    `;
                    break;

                case 'response_feedback':
                    html = `
                        <div style="font-size: 24px; text-align: center; margin: 10px 0;">
                            ${data.feedback === 'positive' ? 'üëç' : 'üëé'}
                        </div>
                        ${data.screenshot && data.screenshot.prices ?
                            `<div style="margin-top: 8px;">Prices: ${data.screenshot.prices.join(', ')}</div>` : ''}
                    `;
                    break;

                case 'error_occurred':
                    html = `
                        <div style="color: #dc2626;">
                            Type: ${data.errorType}<br>
                            ${data.errorDetails ? `Details: ${JSON.stringify(data.errorDetails)}` : ''}
                        </div>
                    `;
                    break;

                case 'health_check':
                    if (data.checks) {
                        const priceHealth = data.checks.priceEndpoint?.status || 'unknown';
                        const chatHealth = data.checks.chatEndpoint?.status || 'unknown';
                        html = `
                            <div style="display: flex; gap: 20px;">
                                <span>Price API: ${getHealthIcon(priceHealth)} ${priceHealth}</span>
                                <span>Chat API: ${getHealthIcon(chatHealth)} ${chatHealth}</span>
                            </div>
                        `;
                    }
                    break;

                default:
                    html = `<pre style="font-size: 11px; max-height: 100px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            }

            return html;
        }

        function getHealthIcon(status) {
            if (status === 'healthy') return 'üü¢';
            if (status === 'unhealthy' || status === 'error') return 'üî¥';
            return 'üü°';
        }

        function filterEvents(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderEvents();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Auto-refresh every 5 seconds
        setInterval(() => {
            loadData();
        }, 5000);

        // Initial load
        loadData();
    </script>
</body>
</html>